<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/webapp/favicon.png">
  <title>
    Cratery -- Documentation generation jobs
  </title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<header style="position: sticky; top: 0;">
  <nav class="bg-white border-gray-200 px-4 lg:px-6 py-2.5 dark:bg-gray-800">
      <div class="flex flex-wrap justify-between items-center mx-auto max-w-screen-xl">
          <a href="/webapp/index.html" class="flex items-center">
              <img src="./logo-white.svg" class="mr-3 h-6 sm:h-9" style="min-width: 200px;" alt="Cratery Logo" />
          </a>
          <div class="flex items-center lg:order-2">
            <a id="link-admin" href="/webapp/admin.html" style="cursor: pointer;" class="text-gray-800 dark:text-white hover:bg-gray-50 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-4 lg:px-5 py-2 lg:py-2.5 mr-2 dark:hover:bg-gray-700 focus:outline-none dark:focus:ring-gray-800">Admin</a>
            <a id="link-account" href="/webapp/account.html" style="cursor: pointer;" class="text-gray-800 dark:text-white hover:bg-gray-50 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-4 lg:px-5 py-2 lg:py-2.5 mr-2 dark:hover:bg-gray-700 focus:outline-none dark:focus:ring-gray-800">My Account</a>
            <a onclick="doLogout()" style="cursor: pointer;" class="text-gray-800 dark:text-white hover:bg-gray-50 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-4 lg:px-5 py-2 lg:py-2.5 mr-2 dark:hover:bg-gray-700 focus:outline-none dark:focus:ring-gray-800">Logout</a>
          </div>
      </div>
  </nav>
</header>
<body onload="doPageLoad()" class="bg-white dark:bg-gray-800">
  <section class="bg-white dark:bg-gray-900">
    <div class="p-2 flex flex-row flex-wrap">
      <a href="/webapp/admin.html" class="font-medium text-blue-600 dark:text-blue-500 hover:underline">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6" style="display: inline-block;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
        </svg>
       Back to admin
      </a>
    </div>
    <div class="py-4 lg:py-4 px-4 mx-auto max-w-screen-xxl">
      <h2 class="mb-4 text-4xl tracking-tight font-extrabold text-center text-gray-900 dark:text-white">Documentation generation jobs</h2>
      <div class="relative overflow-x-auto space-y-8">
        <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
              <tr>
                <th scope="col" class="px-6 py-3">
                    Crate / Version
                </th>
                <th scope="col" class="px-6 py-3">
                    Status
                </th>
                <th scope="col" class="px-6 py-3">
                    Actions
                </th>
              </tr>
            </thead>
            <tbody id="jobs">
            </tbody>
        </table>
      </div>
    </div>
  </section>
  <div id="modal-failure-info" tabindex="-1" class="overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 w-full md:inset-0 h-modal md:h-full" style="display: none;">
    <div class="overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-51 w-full md:inset-0 h-modal md:h-full" style="background-color: black; opacity: 0.75;"></div>
    <div class="relative" style="margin: auto; margin-top: 10%; width: 800px;">
        <div class="relative p-4 bg-white rounded-lg shadow dark:bg-gray-800 md:p-8">
            <div class="mb-4 text-sm font-light text-gray-500 dark:text-gray-400">
              <h3 class="mb-3 text-2xl font-bold text-gray-900 dark:text-white">Log</h3>
            </div>
            <form class="mb-3 space-y-8">
              <textarea id="modal-failure-info-log" rows="10" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"></textarea>
            </form>
            <div class="justify-between items-center pt-0 space-y-4 sm:flex sm:space-y-0">
              <div class="items-center space-y-4 sm:space-x-4 sm:flex sm:space-y-0">
                <button id="modal-failure-info-close" type="button"  class="py-2 px-4 w-full text-sm font-medium text-gray-500 bg-white rounded-lg border border-gray-200 sm:w-auto hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-primary-300 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">Close</button>
              </div>
            </div>
        </div>
    </div>
  </div>
</body>
<footer class="p-4 bg-white md:p-8 lg:p-10 dark:bg-gray-800">
  <div class="mx-auto max-w-screen-xl text-center">
      <span class="text-sm text-gray-500 sm:text-center dark:text-gray-400">Version <span id="version"></span>, Copyright © <span id="year"></span> <a href="https://cenotelie.fr/" target="_blank" class="hover:underline">Cénotélie</a>. All Rights Reserved.</span>
  </div>
</footer>

<link href="/webapp/index.css" rel="stylesheet" />
<script src="/webapp/api.js"></script>
<script src="/webapp/index.js"></script>
<script>
    function doPageLoad() {
      onPageLoad().then((_user) => {
        apiGetDocGenJobs().then(jobs => {
          const jobsEl = document.getElementById("jobs");
          for (const job of jobs) {
            jobsEl.appendChild(renderJob(job));
          }
        })
      });
    }

    function renderJob(job) {
      const linkEl = document.createElement("a");
      linkEl.className = "font-medium text-blue-600 dark:text-blue-500 hover:underline";
      linkEl.setAttribute("href", `/crates/${job.spec.name}/${job.spec.version}`);
      linkEl.appendChild(document.createTextNode(`${job.spec.name} ${job.spec.version}`));

      const color = getJobStatusColor(job.state);
      const statusEl = document.createElement("span");
      statusEl.className = `bg-${color}-100 text-${color}-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded dark:bg-${color}-900 dark:text-${color}-300`;
      statusEl.style.display = "inline-block";
      statusEl.appendChild(document.createTextNode(getJobStatusText(job.state)));
      if (job.state === "Failure") {
        statusEl.style.cursor = "pointer";
        statusEl.onclick = () => {
          document.getElementById('modal-failure-info-log').value = job.output;
          const closeEl = document.getElementById('modal-failure-info-close');
          closeEl.addEventListener('click', function() {
            modalEl.style.display = "none";
          });
          const modalEl = document.getElementById('modal-failure-info');
          modalEl.style.display = "unset";
        };
      }

      const row = document.createElement("tr");
      const cell1 = document.createElement("th");
      cell1.setAttribute("scope", "row");
      cell1.className = "px-6 py-4 font-medium";
      cell1.appendChild(linkEl);
      const cell2 = document.createElement("td");
      cell2.className = "px-6 py-4";
      cell2.appendChild(statusEl);
      const cell3 = document.createElement("td");
      cell3.className = "px-6 py-4";

      if (job.state === "Failure") {
        const refreshEl = document.createElement("span");
        refreshEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">\
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />\
          </svg>';
        refreshEl.title = "Retry";
        refreshEl.style.cursor = "pointer";
        refreshEl.style.display = "inline-block";
        refreshEl.onclick = () => {
          apiRegenCrateDoc(job.spec.name, job.spec.version).then(() => {
            window.location.reload();
          });
        };
        cell3.appendChild(refreshEl);
      }

      row.appendChild(cell1);
      row.appendChild(cell2);
      row.appendChild(cell3);
      return row;
    }
</script>
</html>